{{ define "main" }}

<!-- App Bar CSS -->
{{- $appBarCSS := resources.Get "css/app-bar.css" -}}
{{- if $appBarCSS -}}
    {{- if hugo.IsProduction -}}
        {{- $appBarCSS = $appBarCSS | minify | fingerprint -}}
    {{- end -}}
    <link rel="stylesheet" href="{{ $appBarCSS.RelPermalink }}">
{{- end -}}

<!-- Volumetric Cloud Scroll CSS -->
<link rel="stylesheet" href="{{ "css/volumetric-cloud-scroll.css" | relURL }}">

<!-- Skip to content for keyboard users -->
<a class="sr-only focus:not-sr-only inline-block p-3 bg-white text-primary rounded-md shadow-lg z-50"
    href="#mainContent">Skip to content</a>

<!-- App Bar Header -->
{{ partial "header.html" . }}

<!-- Volumetric Cloud Canvas Container -->
<div id="volumetric-cloud-canvas" role="img" aria-label="Volumetric cloud background animation">
    <span class="sr-only">Decorative cloud background. Scroll down to view content.</span>
</div>

<!-- Scroll Progress Indicator -->
<div id="scroll-indicator" aria-hidden="true"></div>

<main id="mainContent">

    <style>
        /* ==========================================
   BASEET STUDIO LOADER WITH WEBGL VOLUMETRIC CLOUDS
   ========================================== */

        .baseet-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            overflow: hidden;
            transition: opacity 0.8s ease, transform 0.8s ease;
        }

        .baseet-loader.scrolled {
            opacity: 0;
            transform: translateY(-100%);
            pointer-events: none;
        }

        /* WebGL Cloud Canvas - Fixed sizing for WebGL rendering */
        #heroCloudCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
            z-index: 1;
            pointer-events: none;
        }

        /* Main Title */
        .baseet-title {
            position: relative;
            z-index: 2;
            text-align: center;
            perspective: 1000px;
        }

        .baseet-title h1 {
            font-size: clamp(3rem, 8vw, 8rem);
            font-weight: 900;
            letter-spacing: 0.1em;
            background: linear-gradient(135deg, #ffffff 0%, #496BC1 50%, #FBCD37 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 80px rgba(73, 107, 193, 0.5);
            animation: titlePulse 3s ease-in-out infinite;
            transition: filter 0.6s ease, transform 0.6s ease;
        }

        .baseet-loader.reveal .baseet-title h1 {
            filter: blur(0px);
            transform: scale(1.05);
        }

        @keyframes titlePulse {

            0%,
            100% {
                text-shadow: 0 0 80px rgba(73, 107, 193, 0.5),
                    0 0 40px rgba(251, 205, 55, 0.3);
            }

            50% {
                text-shadow: 0 0 120px rgba(73, 107, 193, 0.8),
                    0 0 60px rgba(251, 205, 55, 0.5);
            }
        }

        /* Scroll Indicator */
        .scroll-indicator {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 4;
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            font-weight: 500;
            letter-spacing: 0.1em;
            animation: scrollBounce 2s ease-in-out infinite;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .baseet-loader.scrolled .scroll-indicator {
            opacity: 0;
        }

        .scroll-indicator i {
            display: block;
            margin-top: 10px;
            font-size: 1.5rem;
            color: #FBCD37;
        }

        @keyframes scrollBounce {

            0%,
            100% {
                transform: translateX(-50%) translateY(0);
            }

            50% {
                transform: translateX(-50%) translateY(-15px);
            }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .cloud {
                transform: scale(0.7);
            }

            .cloud-1 {
                top: 10%;
                left: -10%;
            }

            .cloud-2 {
                top: 55%;
                right: -10%;
            }

            .cloud-3 {
                bottom: 15%;
                left: 15%;
            }

            .cloud-4 {
                top: 25%;
                left: -15%;
            }

            .cloud-5 {
                top: 45%;
                right: -5%;
            }

            .cloud-6 {
                bottom: 20%;
                right: 10%;
            }
        }

        /* Hide loader after scrolling */
        body.loaded .baseet-loader {
            display: none;
        }

        /* Main content wrapper - optimized for performance */
        .main-content {
            position: relative;
            opacity: 0;
            transform: translate3d(0, 80vh, 0);
            will-change: transform, opacity;
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1),
                transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Revealing state - cross-fade begins */
        body.revealing .main-content {
            opacity: 1;
            transform: translate3d(0, 0, 0);
        }

        /* Loader fade-out during cross-fade */
        body.revealing .baseet-loader {
            opacity: 0;
            transform: translateY(-5vh);
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1),
                transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Final loaded state */
        body.loaded .main-content {
            opacity: 1;
            transform: translate3d(0, 0, 0);
            will-change: auto;
        }

        /* Performance optimizations */
        @media (prefers-reduced-motion: reduce) {

            .main-content,
            body.revealing .baseet-loader {
                transition-duration: 0.3s;
            }

            /* Disable cloud animations for accessibility */
            #heroCloudCanvas {
                opacity: 0.5;
            }

            .baseet-title h1 {
                animation: none !important;
                text-shadow: 0 0 80px rgba(73, 107, 193, 0.5) !important;
            }

            .scroll-indicator {
                animation: none !important;
            }
        }

        /* Mobile optimization */
        @media (max-width: 768px) {
            .main-content {
                transform: translate3d(0, 50vh, 0);
            }
        }
    </style>

    <!-- Full Screen Loading Animation with WebGL Volumetric Clouds -->
    <div id="baseet-loader" class="baseet-loader">
        <!-- WebGL Volumetric Cloud Canvas -->
        <canvas id="heroCloudCanvas"></canvas>

        <!-- Main title -->
        <div class="baseet-title">
            <h1>BASEET STUDIO</h1>
        </div>

        <!-- Scroll indicator -->
        <div class="scroll-indicator">
            <span>Scroll to explore</span>
            <i class="fas fa-chevron-down"></i>
        </div>
    </div>

    <!-- Main content wrapper for slide-up animation -->
    <div class="main-content">
        {{ with site.Data.home.hero }}{{ if .enable }}{{ partial "blocks/home/hero" . }}{{ end }}{{ end }}
        {{ with site.Data.home.features }}{{ if .enable }}{{ partial "blocks/home/features" . }}{{ end }}{{ end }}
        {{ with site.Data.home.team }}{{ if .enable }}{{ partial "blocks/home/team" . }}{{ end }}{{ end }}
        {{ with site.Data.home.highlights }}{{ if .enable }}{{ partial "blocks/home/highlights" . }}{{ end }}{{ end }}
        {{ with site.Data.home.clients }}{{ if .enable }}{{ partial "blocks/home/clients" . }}{{ end }}{{ end }}
    </div>

    <script>
        // Baseet Studio Loader - WebGL Cloud Animation with Intersection Observer
        (function () {
            const loader = document.getElementById('baseet-loader');
            const mainContent = document.querySelector('.main-content');
            const title = document.querySelector('.baseet-title h1');
            const cloudCanvas = document.getElementById('heroCloudCanvas');

            let animationComplete = false;
            let transitionComplete = false;
            let currentScrollProgress = 0;
            let lastScrollY = 0;
            let scrollDirection = 'down'; // Track scroll direction

            // Check for reduced motion preference
            const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

            // Asymmetric scroll behavior constants
            const SCROLL_DOWN_THRESHOLD = prefersReducedMotion ? 100 : 400; // More space for transition
            const SCROLL_UP_THRESHOLD = prefersReducedMotion ? 150 : 600;   // More space going back
            const STAGING_ZONE = prefersReducedMotion ? 50 : 150;

            /**
             * Calculate scroll progress with asymmetric behavior
             * DOWN: Smooth transition (400px) - more space between clouds and hero
             * UP: Slow with staging area (600px with resistance)
             */
            function getScrollProgress(scrollY, direction) {
                if (direction === 'down') {
                    // Fast transition when scrolling down
                    return Math.min(scrollY / SCROLL_DOWN_THRESHOLD, 1);
                } else {
                    // Slow with staging resistance when scrolling up
                    if (scrollY < STAGING_ZONE) {
                        // Resistance zone - exponential curve
                        return Math.pow(scrollY / STAGING_ZONE, 3) * 0.2;
                    } else {
                        // Normal zone
                        return 0.2 + ((scrollY - STAGING_ZONE) / (SCROLL_UP_THRESHOLD - STAGING_ZONE)) * 0.8;
                    }
                }
            }

            // Handle scroll to animate clouds (bidirectional with asymmetric speed)
            function handleScroll() {
                const scrollY = window.scrollY || window.pageYOffset;
                
                // Detect scroll direction
                scrollDirection = scrollY > lastScrollY ? 'down' : 'up';
                lastScrollY = scrollY;
                
                // If transition is complete and user scrolls back to top
                if (transitionComplete && scrollY < 50) {
                    // Reset animation state when scrolling back to top
                    animationComplete = false;
                    transitionComplete = false;
                    currentScrollProgress = 0;
                    document.body.classList.remove('loaded', 'revealing');
                    loader.style.display = 'flex';
                    
                    // Reset title transforms
                    if (title) {
                        title.style.filter = '';
                        title.style.transform = '';
                        title.style.textShadow = '';
                    }
                    
                    // Notify WebGL clouds to reset (if available)
                    if (window.heroCloudRenderer) {
                        window.heroCloudRenderer.resetAnimation();
                    }
                    return;
                }

                // Calculate progress based on scroll direction
                const threshold = scrollDirection === 'down' ? SCROLL_DOWN_THRESHOLD : SCROLL_UP_THRESHOLD;

                // Animation completes when threshold is reached
                if (scrollY >= threshold && !animationComplete) {
                    animationComplete = true;

                    // Ensure final state is reached
                    if (title) {
                        title.style.filter = 'blur(0px)';
                        title.style.transform = 'scale(1.2)';
                    }
                    
                    // Notify WebGL clouds animation is complete
                    if (window.heroCloudRenderer) {
                        window.heroCloudRenderer.setAnimationProgress(1);
                    }

                    // Brief pause before transition
                    setTimeout(() => {
                        // Trigger cross-fade transition
                        document.body.classList.add('revealing');

                        // Complete transition after 800ms
                        setTimeout(() => {
                            document.body.classList.add('loaded');
                            transitionComplete = true;
                            
                            // Hide loader completely
                            loader.style.display = 'none';

                            // Re-enable body scroll and remove will-change
                            document.body.style.overflow = 'auto';
                            if (mainContent) {
                                mainContent.style.willChange = 'auto';
                            }
                        }, 800);
                    }, 15);
                }
            }

            // Parallax effect on scroll with asymmetric speed (bidirectional)
            function parallaxClouds() {
                if (animationComplete) return;

                const scrollY = window.scrollY || window.pageYOffset;
                
                // Calculate progress based on scroll direction (asymmetric)
                const scrollPercent = getScrollProgress(scrollY, scrollDirection);
                currentScrollProgress = scrollPercent;

                // Smooth easing function for better animation
                const easeOut = 1 - Math.pow(1 - scrollPercent, 3);

                // Update WebGL cloud renderer with scroll progress
                if (window.heroCloudRenderer) {
                    window.heroCloudRenderer.setAnimationProgress(easeOut);
                }

                // Clear title blur as clouds move - gradual clarity
                if (title) {
                    const blurAmount = Math.max(0, 8 - easeOut * 8);
                    const scale = 1 + easeOut * 0.2;
                    title.style.filter = `blur(${blurAmount}px)`;
                    title.style.transform = `scale(${scale})`;
                    title.style.transition = 'none';

                    // Add glow effect as it becomes clearer
                    const glowIntensity = easeOut * 150;
                    title.style.textShadow = `0 0 ${glowIntensity}px rgba(73, 107, 193, ${easeOut * 0.8}),
                                          0 0 ${glowIntensity / 2}px rgba(251, 205, 55, ${easeOut * 0.6})`;
                }

                // Add reveal class when partially scrolled
                if (scrollPercent > 0.3 && !loader.classList.contains('reveal')) {
                    loader.classList.add('reveal');
                } else if (scrollPercent <= 0.3 && loader.classList.contains('reveal')) {
                    loader.classList.remove('reveal');
                }
            }

            // Smooth scroll handling with requestAnimationFrame
            let ticking = false;
            window.addEventListener('scroll', function () {
                if (!ticking) {
                    window.requestAnimationFrame(function () {
                        parallaxClouds();
                        handleScroll();
                        ticking = false;
                    });
                    ticking = true;
                }
            }, { passive: true });

            // Optional: Allow manual start with click (only trigger scroll if user wants)
            loader.addEventListener('click', function () {
                if (!animationComplete && !transitionComplete) {
                    // Gentle scroll to start animation
                    window.scrollBy({ top: 300, behavior: 'smooth' });
                }
            });
        })();
    </script>

    <!-- Performance Optimization Script -->
    {{- $performance := resources.Get "js/performance.js" -}}
    {{- if $performance -}}
    <script src="{{ $performance.Permalink }}" defer fetchpriority="high"></script>
    {{- end -}}

    <!-- Enhanced Animations Script -->
    {{- $animations := resources.Get "js/animations.js" -}}
    {{- if $animations -}}
    <script src="{{ $animations.Permalink }}" defer fetchpriority="high"></script>
    {{- end -}}

    <!-- AJAX Form Handler -->
    {{- $formHandler := resources.Get "js/form-handler.js" -}}
    {{- if $formHandler -}}
    <script src="{{ $formHandler.Permalink }}" defer fetchpriority="low"></script>
    {{- end -}}

    <!-- Preconnect to external domains for faster loading -->
    <link rel="preconnect" href="https://images.unsplash.com" crossorigin>
    <link rel="dns-prefetch" href="https://formspree.io">

    <!-- WebGL Volumetric Cloud Scripts -->
    {{- $shaders := resources.Get "js/volumetric-clouds/shaders.js" -}}
    {{- if $shaders -}}
    <script src="{{ $shaders.Permalink }}"></script>
    {{- end -}}
    
    <!-- THREE.js Library (CDN for WebGL support) -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    
    <!-- WebGL Volumetric Cloud Scripts (in dependency order) -->
    {{- $improvedNoise := resources.Get "js/volumetric-clouds/improved-noise.js" -}}
    {{- if $improvedNoise -}}
    <script src="{{ $improvedNoise.Permalink }}"></script>
    {{- end -}}
    
    {{- $shaders := resources.Get "js/volumetric-clouds/shaders.js" -}}
    {{- if $shaders -}}
    <script src="{{ $shaders.Permalink }}"></script>
    {{- end -}}
    
    {{- $textureGen := resources.Get "js/volumetric-clouds/texture-generator.js" -}}
    {{- if $textureGen -}}
    <script src="{{ $textureGen.Permalink }}"></script>
    {{- end -}}
    
    {{- $heroAdapter := resources.Get "js/volumetric-clouds/hero-cloud-adapter.js" -}}
    {{- if $heroAdapter -}}
    <script src="{{ $heroAdapter.Permalink }}"></script>
    {{- end -}}

    <!-- Initialize Hero Clouds -->
    <script>
        // Wait for all dependencies to load before initializing
        function initHeroClouds() {
            const canvas = document.getElementById('heroCloudCanvas');
            
            // Check all dependencies are loaded
            if (!canvas) {
                console.error('Canvas element not found');
                return;
            }
            
            if (!window.THREE) {
                console.error('THREE.js not loaded yet, retrying...');
                setTimeout(initHeroClouds, 100);
                return;
            }
            
            if (!window.CloudRenderer) {
                console.error('CloudRenderer not loaded yet, retrying...');
                setTimeout(initHeroClouds, 100);
                return;
            }
            
            // Verify canvas has dimensions
            const rect = canvas.getBoundingClientRect();
            if (rect.width === 0 || rect.height === 0) {
                console.warn('Canvas has no dimensions, waiting for layout...');
                requestAnimationFrame(initHeroClouds);
                return;
            }
            
            console.log('Initializing CloudRenderer with canvas dimensions:', rect.width, 'x', rect.height);
            
            // Initialize renderer
            try {
                window.heroCloudRenderer = new CloudRenderer(canvas, {
                    density: 0.8,
                    scale: 1.5,
                    scrollEnabled: false // We'll control it manually
                });
                window.heroCloudRenderer.init();
                console.log('CloudRenderer initialized successfully');
            } catch (error) {
                console.error('Failed to initialize CloudRenderer:', error);
            }
        }
        
        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initHeroClouds);
        } else {
            initHeroClouds();
        }
    </script>

</main>
{{ end }}