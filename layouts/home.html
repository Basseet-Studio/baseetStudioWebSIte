{{ define "main" }}
  <!-- App Bar CSS -->
  {{- $appBarCSS := resources.Get "css/app-bar.css" -}}
  {{- if $appBarCSS -}}
    {{- if hugo.IsProduction -}}
      {{- $appBarCSS = $appBarCSS | minify | fingerprint -}}
    {{- end -}}
    <link rel="stylesheet" href="{{ $appBarCSS.RelPermalink }}" />
  {{- end -}}


  <!-- Shadertoy Clouds CSS -->
  {{- $cloudCSS := resources.Get "css/shadertoy-clouds.css" -}}
  {{- if $cloudCSS -}}
    {{- if hugo.IsProduction -}}
      {{- $cloudCSS = $cloudCSS | minify | fingerprint -}}
    {{- end -}}
    <link rel="stylesheet" href="{{ $cloudCSS.RelPermalink }}" />
  {{- end -}}

  <!-- Custom Overrides CSS to fix theme conflicts -->
  {{- $overridesCSS := resources.Get "css/custom-overrides.css" -}}
  {{- if $overridesCSS -}}
    {{- if hugo.IsProduction -}}
      {{- $overridesCSS = $overridesCSS | minify | fingerprint -}}
    {{- end -}}
    <link rel="stylesheet" href="{{ $overridesCSS.RelPermalink }}" />
  {{- end -}}


  <!-- Skip to content for keyboard users -->
  <a class="skip-to-content" href="#mainContent">Skip to content</a>

  <!-- Screen reader description for cloud scene -->
  <div class="sr-only" role="region" aria-label="Animated cloud scene">
    An animated 3D cloud scene with the text "BASEET STUDIO". Scroll down to navigate through the clouds and reach the
    main content.
  </div>

  <!-- Cloud Canvas Container -->
  <div class="cloud-canvas-container" id="cloudCanvasContainer">
    <canvas id="cloudCanvas" aria-label="3D volumetric cloud animation"></canvas>
  </div>

  <!-- Scroll Indicator -->
  <div class="scroll-indicator" id="scrollIndicator">
    <span>Scroll to explore</span>
    <div class="scroll-indicator-icon"></div>
  </div>

  <!-- App Bar Header -->
  {{ partial "header.html" . }}


  <main id="mainContent" class="main-content-wrapper">
    <!-- Main content -->
    {{ with site.Data.home.hero }}{{ if .enable }}{{ partial "blocks/home/hero" . }}{{ end }}{{ end }}
    {{ with site.Data.home.features }}{{ if .enable }}{{ partial "blocks/home/features" . }}{{ end }}{{ end }}
    {{ with site.Data.home.team }}{{ if .enable }}{{ partial "blocks/home/team" . }}{{ end }}{{ end }}
    {{ with site.Data.home.highlights }}{{ if .enable }}{{ partial "blocks/home/highlights" . }}{{ end }}{{ end }}
    {{ with site.Data.home.clients }}{{ if .enable }}{{ partial "blocks/home/clients" . }}{{ end }}{{ end }}


    <!-- Performance Optimization Script -->
    {{- $performance := resources.Get "js/performance.js" -}}
    {{- if $performance -}}
      <script src="{{ $performance.Permalink }}" defer fetchpriority="high"></script>
    {{- end -}}


    <!-- Enhanced Animations Script -->
    {{- $animations := resources.Get "js/animations.js" -}}
    {{- if $animations -}}
      <script src="{{ $animations.Permalink }}" defer fetchpriority="high"></script>
    {{- end -}}


    <!-- AJAX Form Handler -->
    {{- $formHandler := resources.Get "js/form-handler.js" -}}
    {{- if $formHandler -}}
      <script src="{{ $formHandler.Permalink }}" defer fetchpriority="low"></script>
    {{- end -}}


    <!-- Preconnect to external domains for faster loading -->
    <link rel="preconnect" href="https://images.unsplash.com" crossorigin />
    <link rel="dns-prefetch" href="https://formspree.io" />

    <!-- Import map for Three.js modules -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
          "three/": "https://cdn.jsdelivr.net/npm/three@0.160.0/"
        }
      }
    </script>

    <!-- Shadertoy Cloud System -->
    <script type="module">
      import { ShadertoyCloudRenderer } from '/js/shadertoy-clouds/shadertoy-cloud-renderer.js';
      import { ScrollController } from '/js/shadertoy-clouds/scroll-controller.js';

      // Initialize cloud renderer when DOM is ready
      async function initCloudSystem() {
        try {
          console.log('Initializing Shadertoy cloud system...');

          // Create renderer instance
          const renderer = new ShadertoyCloudRenderer('cloudCanvas', {
            scrollDistance: 600,
            textContent: 'BASEET STUDIO',
            fontSize: 0.8,
            cloudDensity: 0.7,
            lookMode: 1,
            noiseMethod: 1,
            useLOD: true
          });

          // Initialize renderer (loads textures, creates scene)
          await renderer.init();
          console.log('Cloud renderer initialized');

          // Start animation
          renderer.start();

          // Create scroll controller
          const scrollController = new ScrollController(renderer, {
            scrollDistance: 600,
            resetThreshold: 50,
            onComplete: () => {
              console.log('Scroll complete - triggering transition');
              handleTransitionComplete();
            },
            onReset: () => {
              console.log('Scroll reset - returning to initial state');
              handleTransitionReset();
            }
          });

          // Enable scroll controller
          scrollController.enable();

          // Store references globally for debugging
          window.cloudRenderer = renderer;
          window.cloudScrollController = scrollController;

          console.log('Cloud system ready');
          console.log('DEBUG COMMANDS AVAILABLE:');
          console.log('  cloudRenderer.setDebugMode(n) - Set debug visualization (0-5)');
          console.log('  cloudRenderer.getDebugInfo() - Get current state info');
          console.log('  Debug modes: 0=normal, 1=UV, 2=coords, 3=ray dir, 4=noise, 5=density');

        } catch (error) {
          console.error('Failed to initialize cloud system:', error);
          // Fallback: hide cloud canvas and show content immediately
          handleWebGLFallback();
        }
      }

      // Handle transition complete (scroll reached 100%)
      function handleTransitionComplete() {
        const body = document.body;
        const mainContent = document.querySelector('.main-content-wrapper');
        const cloudContainer = document.getElementById('cloudCanvasContainer');
        const scrollIndicator = document.getElementById('scrollIndicator');

        // Add revealing class to start transition
        body.classList.add('revealing');
        if (mainContent) {
          mainContent.classList.add('revealing');
        }

        // Hide scroll indicator
        if (scrollIndicator) {
          scrollIndicator.classList.add('hidden');
        }

        // After transition, add loaded class and hide clouds
        setTimeout(() => {
          body.classList.add('loaded');
          if (mainContent) {
            mainContent.classList.add('loaded');
          }
          if (cloudContainer) {
            cloudContainer.classList.add('fade-out');
          }
        }, 800);
      }

      // Handle transition reset (scrolled back to top)
      function handleTransitionReset() {
        const body = document.body;
        const mainContent = document.querySelector('.main-content-wrapper');
        const cloudContainer = document.getElementById('cloudCanvasContainer');
        const scrollIndicator = document.getElementById('scrollIndicator');

        // Remove all transition classes
        body.classList.remove('revealing', 'loaded');
        if (mainContent) {
          mainContent.classList.remove('revealing', 'loaded');
        }
        if (cloudContainer) {
          cloudContainer.classList.remove('fade-out');
        }

        // Show scroll indicator again
        if (scrollIndicator) {
          scrollIndicator.classList.remove('hidden');
        }
      }

      // Handle WebGL fallback (no WebGL support)
      function handleWebGLFallback() {
        console.warn('WebGL not supported, showing content immediately');
        const body = document.body;
        const mainContent = document.querySelector('.main-content-wrapper');
        const cloudContainer = document.getElementById('cloudCanvasContainer');
        const scrollIndicator = document.getElementById('scrollIndicator');

        // Hide cloud elements
        if (cloudContainer) {
          cloudContainer.style.display = 'none';
        }
        if (scrollIndicator) {
          scrollIndicator.style.display = 'none';
        }

        // Show content immediately
        body.classList.add('loaded');
        if (mainContent) {
          mainContent.classList.add('loaded');
          mainContent.style.paddingTop = '0';
        }
      }

      // Initialize when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCloudSystem);
      } else {
        initCloudSystem();
      }
    </script>
  </main>
{{ end }}
