{{- if .enable -}}
<section id="projects"
    class="projects projects-section relative py-16 xl:py-24 overflow-hidden bg-gradient-to-b from-white to-[#F8F9FA]">
    <div class="container mx-auto px-4">
        <!-- Section Header -->
        <div class="text-center mb-12 scroll-animate">
            <h2 class="projects-title text-3xl xl:text-5xl font-bold text-[#252525] mb-4">
                {{ .title | safeHTML }}
            </h2>
            {{- if .subtitle -}}
            <p class="text-xl text-primary font-semibold mb-4">{{ .subtitle }}</p>
            {{- end -}}
            {{- if .text -}}
            <p class="max-w-2xl mx-auto text-[#545454] text-lg leading-relaxed">{{ .text }}</p>
            {{- end -}}
        </div>

        <!-- Premium Carousel Container -->
        <div class="projects-carousel-wrapper relative max-w-7xl mx-auto">
            <!-- Navigation Arrows -->
            <button class="carousel-arrow carousel-arrow-left" aria-label="Previous projects">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <button class="carousel-arrow carousel-arrow-right" aria-label="Next projects">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>

            <!-- Carousel Track -->
            <div class="projects-carousel-viewport overflow-hidden">
                <div class="projects-carousel-track flex transition-transform duration-500 ease-out">
                    {{- range $index, $project := .items -}}
                    <article class="projects-carousel-slide flex-shrink-0 w-full md:w-1/2 xl:w-1/3 px-4"
                        data-index="{{ $index }}">
                        <div class="project-card-premium group relative bg-white rounded-3xl shadow-lg overflow-hidden h-full"
                            style="--project-color: {{ $project.color }};">
                            <!-- Gradient Top Border -->
                            <div class="project-gradient-bar absolute top-0 left-0 right-0 h-1.5"
                                style="background: {{ $project.gradient | safeCSS }};"></div>

                            <!-- Card Content -->
                            <div class="p-6 xl:p-8 relative z-10 flex flex-col h-full">
                                <!-- App Icon & Status -->
                                <div class="flex items-start justify-between mb-4">
                                    <div class="project-icon-container relative">
                                        <!-- App Icon with Font Awesome -->
                                        <div class="w-16 h-16 rounded-xl flex items-center justify-center text-white text-2xl shadow-lg transition-transform duration-500 group-hover:scale-110 group-hover:rotate-3"
                                            style="background: {{ $project.gradient | safeCSS }};">
                                            {{- if $project.iconClass -}}
                                            <i class="{{ $project.iconClass }}"></i>
                                            {{- else -}}
                                            {{ substr $project.name 0 1 }}
                                            {{- end -}}
                                        </div>
                                    </div>
                                    {{- if $project.status -}}
                                    <span class="project-status-badge px-3 py-1 text-xs font-semibold rounded-full"
                                        style="background: {{ $project.color }}20; color: {{ $project.color }};">
                                        {{ $project.status }}
                                    </span>
                                    {{- end -}}
                                </div>

                                <!-- App Name & Tagline -->
                                <h3 class="project-name-premium text-xl xl:text-2xl font-bold text-[#252525] mb-1">
                                    {{ $project.name }}
                                </h3>
                                <p class="text-sm font-medium mb-3 transition-colors duration-300"
                                    style="color: {{ $project.color }};">
                                    {{ $project.tagline }}
                                </p>

                                <!-- Description -->
                                <p class="text-[#545454] text-sm leading-relaxed mb-4 line-clamp-3">
                                    {{ $project.description }}
                                </p>

                                <!-- Features List (Compact) -->
                                {{- if $project.features -}}
                                <div class="mb-4 flex-grow">
                                    <ul class="flex flex-wrap gap-2">
                                        {{- range first 4 $project.features -}}
                                        <li
                                            class="project-feature-tag text-xs px-2 py-1 rounded-full bg-gray-100 text-[#545454]">
                                            {{ . }}
                                        </li>
                                        {{- end -}}
                                        {{- if gt (len $project.features) 4 -}}
                                        <li class="text-xs px-2 py-1 rounded-full bg-gray-100 text-[#545454]">
                                            +{{ sub (len $project.features) 4 }} more
                                        </li>
                                        {{- end -}}
                                    </ul>
                                </div>
                                {{- end -}}

                                <!-- Platforms & CTA -->
                                <div class="flex items-center justify-between pt-4 border-t border-gray-100 mt-auto">
                                    <!-- Platform Icons -->
                                    <div class="flex items-center gap-3">
                                        {{- range $project.platforms -}}
                                        <a href="{{ .link }}"
                                            class="project-platform-link flex items-center gap-1 text-[#545454]"
                                            title="Available on {{ .name }}">
                                            <i class="{{ .icon }} text-lg"></i>
                                            <span class="text-xs font-medium hidden sm:inline">{{ .name }}</span>
                                        </a>
                                        {{- end -}}
                                    </div>

                                    <!-- Learn More Link -->
                                    <a href="/projects/{{ $project.slug }}/"
                                        class="project-learn-more inline-flex items-center gap-1 text-sm font-semibold"
                                        style="color: {{ $project.color }};">
                                        Details
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M17 8l4 4m0 0l-4 4m4-4H3" />
                                        </svg>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </article>
                    {{- end -}}
                </div>
            </div>

            <!-- Carousel Dots - Generated dynamically by JS based on slidesPerView -->
            <div class="carousel-dots flex justify-center gap-2 mt-8">
            </div>

            <!-- Progress Bar -->
            <div class="carousel-progress-container mt-4">
                <div class="carousel-progress-bar">
                    <div class="carousel-progress-fill"></div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const carousel = document.querySelector('.projects-carousel-wrapper');
        if (!carousel) return;

        const track = carousel.querySelector('.projects-carousel-track');
        const slides = carousel.querySelectorAll('.projects-carousel-slide');
        const dotsContainer = carousel.querySelector('.carousel-dots');
        const leftArrow = carousel.querySelector('.carousel-arrow-left');
        const rightArrow = carousel.querySelector('.carousel-arrow-right');
        const progressFill = carousel.querySelector('.carousel-progress-fill');

        let currentIndex = 0;
        let slidesPerView = 3;
        let autoplayInterval;
        const totalSlides = slides.length;
        let maxIndex = 0;

        // Calculate slides per view based on screen size
        function updateSlidesPerView() {
            if (window.innerWidth < 768) {
                slidesPerView = 1;
            } else if (window.innerWidth < 1280) {
                slidesPerView = 2;
            } else {
                slidesPerView = 3;
            }
            maxIndex = Math.max(0, totalSlides - slidesPerView);
        }

        // Generate dots based on actual carousel positions
        function generateDots() {
            dotsContainer.innerHTML = '';
            const numDots = maxIndex + 1; // Number of positions

            for (let i = 0; i <= maxIndex; i++) {
                const dot = document.createElement('button');
                dot.className = 'carousel-dot' + (i === currentIndex ? ' active' : '');
                dot.setAttribute('data-index', i);
                dot.setAttribute('aria-label', `Go to slide group ${i + 1}`);
                dot.addEventListener('click', () => goToSlide(i));
                dotsContainer.appendChild(dot);
            }
        }

        // Update carousel position
        function updateCarousel(animate = true) {
            // Wrap around for infinite loop
            if (currentIndex > maxIndex) {
                currentIndex = 0;
            } else if (currentIndex < 0) {
                currentIndex = maxIndex;
            }

            const slideWidth = 100 / slidesPerView;
            const offset = currentIndex * slideWidth;

            track.style.transition = animate ? 'transform 0.5s cubic-bezier(0.23, 1, 0.32, 1)' : 'none';
            track.style.transform = `translateX(-${offset}%)`;

            // Update dots
            const dots = dotsContainer.querySelectorAll('.carousel-dot');
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === currentIndex);
            });

            // Update progress bar
            const progress = ((currentIndex + 1) / (maxIndex + 1)) * 100;
            progressFill.style.width = `${progress}%`;

            // Update arrows visibility (always enabled for infinite loop)
            leftArrow.style.opacity = '1';
            leftArrow.style.pointerEvents = 'auto';
            rightArrow.style.opacity = '1';
            rightArrow.style.pointerEvents = 'auto';
        }

        // Navigation handlers
        function goToSlide(index) {
            currentIndex = index;
            updateCarousel();
            resetAutoplay();
        }

        function nextSlide() {
            currentIndex++;
            if (currentIndex > maxIndex) {
                currentIndex = 0; // Loop back to start
            }
            updateCarousel();
        }

        function prevSlide() {
            currentIndex--;
            if (currentIndex < 0) {
                currentIndex = maxIndex; // Loop to end
            }
            updateCarousel();
        }

        // Autoplay - continuous infinite loop
        function startAutoplay() {
            autoplayInterval = setInterval(() => {
                nextSlide();
            }, 4000);
        }

        function resetAutoplay() {
            clearInterval(autoplayInterval);
            startAutoplay();
        }

        // Event listeners
        leftArrow.addEventListener('click', () => { prevSlide(); resetAutoplay(); });
        rightArrow.addEventListener('click', () => { nextSlide(); resetAutoplay(); });

        // Touch/swipe support
        let touchStartX = 0;
        let touchEndX = 0;

        track.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });

        track.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, { passive: true });

        function handleSwipe() {
            const swipeThreshold = 50;
            const diff = touchStartX - touchEndX;

            if (Math.abs(diff) > swipeThreshold) {
                if (diff > 0) {
                    nextSlide();
                } else {
                    prevSlide();
                }
                resetAutoplay();
            }
        }

        // Keyboard navigation
        carousel.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                prevSlide();
                resetAutoplay();
            } else if (e.key === 'ArrowRight') {
                nextSlide();
                resetAutoplay();
            }
        });

        // Pause autoplay on hover
        carousel.addEventListener('mouseenter', () => clearInterval(autoplayInterval));
        carousel.addEventListener('mouseleave', startAutoplay);

        // Handle resize
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                updateSlidesPerView();
                generateDots();
                updateCarousel(false);
            }, 100);
        });

        // Initialize
        updateSlidesPerView();
        generateDots();
        updateCarousel(false);
        startAutoplay();
    });
</script>
{{- end -}}