<!-- Skip to content for keyboard users -->
<a href="#mainContent" class="skip-to-content">{{ i18n "skip_to_content" }}</a>

<header id="app-bar" class="app-bar" role="banner" dir="ltr">
    <div class="app-bar-container">
        <!-- Logo -->
        <a href="{{ "/" | relLangURL }}" class="app-bar-logo logo-premium" aria-label="{{ i18n "aria_home_link" }}">
            <span class="logo-text">{{ i18n "logo_text" }}</span>
        </a>

        <!-- Desktop Navigation -->
        <nav class="app-bar-nav" aria-label="Main navigation">
            <ul class="nav-links">
                {{ range site.Menus.main }}
                {{ $isActive := false }}
                {{ $currentPath := $.Page.RelPermalink }}
                {{ $menuURL := .URL }}
                {{/* Build the correct URL */}}
                {{ $href := "" }}
                {{ if hasPrefix .URL "#" }}
                    {{/* Hash link - prepend home URL */}}
                    {{ $href = printf "%s%s" ("/" | relLangURL) .URL }}
                {{ else if hasPrefix .URL "/" }}
                    {{/* Absolute path - use relLangURL */}}
                    {{ $href = .URL | relLangURL }}
                {{ else }}
                    {{/* Relative or external URL */}}
                    {{ $href = .URL }}
                {{ end }}
                {{/* Check if current page matches menu item */}}
                {{ if eq .URL "/" }}
                    {{ $isActive = $.Page.IsHome }}
                {{ else if hasPrefix .URL "#" }}
                    {{ $isActive = $.Page.IsHome }}
                {{ else if hasPrefix .URL "/" }}
                    {{ $isActive = hasPrefix $currentPath (.URL | relLangURL) }}
                {{ end }}
                <li><a href="{{ $href }}" class="nav-link-premium {{ if $isActive }}nav-active{{ end }} {{ if eq .Name "Pricing" }}font-bold{{ end }}">{{ .Name }}</a></li>
                {{ end }}
            </ul>
            
            <!-- Language Switcher (Desktop) -->
            {{ partial "language-switcher.html" . }}
        </nav>

        <!-- Mobile Controls -->
        <div class="mobile-controls">
            <!-- Mobile Language Switcher -->
            <div class="mobile-language-switcher">
                {{ range .Site.Home.AllTranslations }}
                <a href="{{ .RelPermalink }}" 
                   class="mobile-lang-btn {{ if eq $.Site.Language.Lang .Language.Lang }}active{{ end }}"
                   lang="{{ .Language.Lang }}"
                   title="{{ .Language.LanguageName }}">
                    {{ if eq .Language.Lang "ar" }}Ø¹{{ else }}EN{{ end }}
                </a>
                {{ end }}
            </div>
            
            <!-- Mobile Menu Toggle -->
            <button class="mobile-menu-toggle" aria-label="{{ i18n "aria_toggle_menu" }}" aria-expanded="false" aria-controls="mobile-menu">
                <span class="hamburger-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </span>
            </button>
        </div>
    </div>
</header>

<!-- Mobile Menu Sidebar (Outside header for proper z-index) -->
<div id="mobile-menu-backdrop" class="mobile-menu-backdrop"></div>
<nav id="mobile-menu" class="mobile-menu" aria-label="Mobile navigation" aria-hidden="true" dir="ltr">
    <ul class="mobile-nav-links">
        {{ range site.Menus.main }}
        {{ $isActive := false }}
        {{ $currentPath := $.Page.RelPermalink }}
        {{/* Build the correct URL */}}
        {{ $href := "" }}
        {{ if hasPrefix .URL "#" }}
            {{ $href = printf "%s%s" ("/" | relLangURL) .URL }}
        {{ else if hasPrefix .URL "/" }}
            {{ $href = .URL | relLangURL }}
        {{ else }}
            {{ $href = .URL }}
        {{ end }}
        {{/* Check if current page matches menu item */}}
        {{ if eq .URL "/" }}
            {{ $isActive = $.Page.IsHome }}
        {{ else if hasPrefix .URL "#" }}
            {{ $isActive = $.Page.IsHome }}
        {{ else if hasPrefix .URL "/" }}
            {{ $isActive = hasPrefix $currentPath (.URL | relLangURL) }}
        {{ end }}
        <li><a href="{{ $href }}" class="mobile-nav-link {{ if $isActive }}mobile-nav-active{{ end }}">{{ .Name }}</a></li>
        {{ end }}
    </ul>
</nav>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Mobile menu script loaded');
    
    // Mobile menu toggle functionality
    const mobileToggle = document.querySelector('.mobile-menu-toggle');
    const mobileMenu = document.getElementById('mobile-menu');
    const backdrop = document.getElementById('mobile-menu-backdrop');

    console.log('Toggle:', mobileToggle);
    console.log('Menu:', mobileMenu);
    console.log('Backdrop:', backdrop);

    if (!mobileToggle || !mobileMenu || !backdrop) {
        console.error('Mobile menu elements not found!');
        return;
    }

    function openMenu() {
        console.log('Opening menu');
        mobileMenu.classList.add('open');
        backdrop.classList.add('open');
        mobileToggle.setAttribute('aria-expanded', 'true');
        mobileMenu.setAttribute('aria-hidden', 'false');
        document.body.classList.add('mobile-menu-open');
    }

    function closeMenu() {
        console.log('Closing menu');
        mobileMenu.classList.remove('open');
        backdrop.classList.remove('open');
        mobileToggle.setAttribute('aria-expanded', 'false');
        mobileMenu.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('mobile-menu-open');
    }

    // Toggle on hamburger click
    mobileToggle.addEventListener('click', function(e) {
        console.log('Hamburger clicked!');
        e.preventDefault();
        e.stopPropagation();
        
        if (mobileMenu.classList.contains('open')) {
            closeMenu();
        } else {
            openMenu();
        }
    });

    // Close on backdrop click
    backdrop.addEventListener('click', function(e) {
        console.log('Backdrop clicked');
        closeMenu();
    });

    // Close on link click
    mobileMenu.querySelectorAll('a').forEach(function(link) {
        link.addEventListener('click', function() {
            console.log('Link clicked');
            closeMenu();
        });
    });

    // Close on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && mobileMenu.classList.contains('open')) {
            closeMenu();
        }
    });
    
    console.log('Mobile menu initialized successfully');
});
</script>
